<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>画像ウォーターマーク</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body {
    font-family: sans-serif;
    padding: 20px;
  }
  canvas {
    max-width: 100%;
    border: 1px solid #ccc;
    margin-top: 10px;
  }
  button {
    margin-top: 10px;
    padding: 8px 16px;
    font-size: 16px;
  }
</style>
</head>
<body>

<h2>画像に文字を入れる</h2>

<input type="file" id="upload" accept="image/*">
<br>

<canvas id="canvas"></canvas>
<br>

<button id="download">画像を保存</button>

<script>
const upload = document.getElementById("upload");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

upload.addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;

  const img = new Image();
  img.onload = () => {
    canvas.width = img.width;
    canvas.height = img.height;

    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(img, 0, 0);

    // === ここが文字入れ部分 ===
    const text = "無断転載禁止 / Do not repost";

    const fontSize = Math.max(16, Math.floor(img.width / 25));
    ctx.font = fontSize + "px sans-serif";
    ctx.fillStyle = "rgba(255,255,255,0.6)";
    ctx.strokeStyle = "rgba(0,0,0,0.4)";
    ctx.lineWidth = 2;

    ctx.textBaseline = "bottom";

    const metrics = ctx.measureText(text);
    const padding = 20;
    const x = img.width - metrics.width - padding;
    const y = img.height - padding;

    // 縁取り＋文字
    ctx.strokeText(text, x, y);
    ctx.fillText(text, x, y);
  };

  img.src = URL.createObjectURL(file);
});

document.getElementById("download").onclick = () => {
  // Safari対応：Blob経由
  canvas.toBlob(blob => {
    if (!blob) return;

    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "watermarked.png";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });
};
</script>

</body>
</html>
